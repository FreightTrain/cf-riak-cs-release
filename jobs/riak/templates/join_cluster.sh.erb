#!/bin/bash

LOG_FILE=/var/vcap/sys/log/riak/join_cluster.log
SEED_NODE=<%= properties.riak.seed_node || "127.0.0.1" %>
RIAK_ADMIN=/var/vcap/packages/riak/rel/bin/riak-admin

function f_logger {
  read message
  prefix="$(date +%Y-%m-%dT%H:%M:%S%z):"
  echo "${prefix} ${message}" >> $LOG_FILE
}

function f_join_cluster {
  cluster_join_status=-1
  while [ $cluster_join_status -ne 0 ]
  do
    echo Joining cluster riak@$SEED_NODE | f_logger
    ${RIAK_ADMIN} cluster join riak@$SEED_NODE
    cluster_join_status=$?
    sleep 2
  done

  echo Successfully joined cluster riak@$SEED_NODE | f_logger
  ${RIAK_ADMIN} cluster plan
  ${RIAK_ADMIN} cluster commit

  is_ready=false

  while [ "$is_ready" == "false" ]
  do
    ring_ready=`${RIAK_ADMIN} ring_status | grep 'Ring Ready'`
    if [[ $ring_ready == *"true"* ]]
    then
      echo "Ring Ready" | f_logger
      is_ready=true
    else
      sleep 1
    fi
  done
}

mkdir -p `dirname $LOG_FILE`

# only try to join cluster if not already joined
if ${RIAK_ADMIN} member-status | egrep -q "riak@${SEED_NODE}"
  then true
  else f_join_cluster
fi

