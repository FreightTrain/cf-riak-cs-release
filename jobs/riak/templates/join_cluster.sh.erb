#!/bin/bash

LOG_FILE=/var/vcap/sys/log/riak/join_cluster.log
SEED_NODE=<%= properties.riak.seed_node || "127.0.0.1" %>
RIAK_ADMIN=/var/vcap/packages/riak/rel/bin/riak-admin

function f_logger {
  read message
  prefix="$(date +%Y-%m-%dT%H:%M:%S%z):"
  echo "${prefix} ${message}" >> $LOG_FILE
}

function f_join_cluster {
  ${RIAK_ADMIN} cluster join riak@$SEED_NODE | f_logger
  join_cluster_status=$?
  if [ $join_cluster_status -eq 0 ]
  then
    ${RIAK_ADMIN} cluster plan | f_logger
    ${RIAK_ADMIN} cluster commit | f_logger

    is_ready=false

    while [ "$is_ready" == "false" ]
    do
      ring_ready=`${RIAK_ADMIN} ring_status | grep 'Ring Ready'`
      if [[ $ring_ready == *"true"* ]]
      then
        echo "Ring Ready" | f_logger
        is_ready=true
      else
        sleep 1
      fi
    done
  else
    echo "riak-admin cluster join riak@$SEED_NODE failed with error code $join_cluster_status" | f_logger
  fi
}

mkdir -p `dirname $LOG_FILE`
mkdir -p `dirname $ERR_FILE`


# only try to join cluster if not already joined
if ${RIAK_ADMIN} member-status | egrep -q "^valid.*riak@${SEED_NODE}"
  then true
  else f_join_cluster
fi

